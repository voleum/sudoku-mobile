# 2.1.2 Выбор основного стека технологий

## Статус: 🔄 В работе
**Дата начала**: 19 сентября 2025
**Ответственный**: voleum

---

## Общая концепция технологического стека

На основе проведенного анализа фреймворков (п. 2.1.1) выбран **React Native** как основная платформа разработки. Теперь определяем полный технологический стек для игры Судоку.

### 🎯 Принципы выбора технологий

1. **Стабильность и надежность** - выбор проверенных решений
2. **Производительность** - оптимизация для мобильных устройств
3. **Простота интеграции** - совместимость компонентов стека
4. **Поддержка сообщества** - активная разработка и документация
5. **Масштабируемость** - возможность роста и развития проекта

---

## 1. Основной фреймворк и язык

### 1.1 React Native Framework

**Выбранная версия**: React Native 0.72+ (текущая стабильная)

**Архитектура**: New Architecture (Fabric + TurboModules)
- Fabric - новый рендеринг движок
- TurboModules - улучшенная система нативных модулей
- Hermes JS Engine для оптимизации производительности

```json
// package.json dependencies
{
  "react": "18.2.0",
  "react-native": "0.72.6"
}
```

### 1.2 TypeScript

**Обоснование выбора**:
- Статическая типизация снижает количество ошибок
- Улучшенная поддержка IDE и автодополнение
- Лучшая читаемость и поддерживаемость кода
- Отличная интеграция с React Native

**Конфигурация**:
```json
// tsconfig.json
{
  "extends": "@react-native/typescript-config/tsconfig.json",
  "compilerOptions": {
    "strict": true,
    "strictNullChecks": true,
    "noImplicitAny": true,
    "noImplicitReturns": true
  }
}
```

**Типы для игры Судоку**:
```typescript
// Основные типы игры
type CellValue = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;
type SudokuGrid = CellValue[][];
type DifficultyLevel = 'easy' | 'medium' | 'hard' | 'expert';

interface GameState {
  grid: SudokuGrid;
  originalGrid: SudokuGrid;
  selectedCell: CellPosition | null;
  gameMode: DifficultyLevel;
  isComplete: boolean;
  errors: number;
  hints: number;
  timer: number;
}
```

---

## 2. Управление состоянием

### 2.1 Zustand - основное хранилище состояния

**Обоснование выбора**:
- Легковесное решение (2.9kb gzipped)
- Простое API без боilerplate кода
- Отличная TypeScript поддержка
- Нет dependency на React Context
- Подходит для игр с локальным состоянием

```typescript
// stores/gameStore.ts
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';

interface GameStore {
  // State
  currentGame: GameState | null;
  settings: GameSettings;
  statistics: PlayerStatistics;

  // Actions
  startNewGame: (difficulty: DifficultyLevel) => void;
  updateCell: (row: number, col: number, value: CellValue) => void;
  saveGame: () => void;
  loadGame: (gameId: string) => void;
}

export const useGameStore = create<GameStore>()(
  devtools(
    persist(
      (set, get) => ({
        // Implementation
      }),
      { name: 'sudoku-game-store' }
    )
  )
);
```

### 2.2 React Query (TanStack Query) - серверное состояние

**Обоснование**:
- Кэширование и синхронизация данных
- Автоматическое обновление в фоне
- Optimistic updates для лучшего UX
- Retry логика и error handling

```typescript
// api/hooks/useStatistics.ts
import { useQuery, useMutation } from '@tanstack/react-query';

export const useStatistics = () => {
  return useQuery({
    queryKey: ['statistics'],
    queryFn: () => statisticsApi.getPlayerStats(),
    staleTime: 5 * 60 * 1000, // 5 минут
  });
};
```

---

## 3. UI библиотеки и компоненты

### 3.1 React Native Elements - базовые компоненты

**Выбор**: React Native Elements v4
- Готовые Material Design компоненты
- Хорошая кастомизация и темизация
- Широкий набор компонентов
- Активная поддержка

```typescript
// components/ui/Button.tsx
import { Button as RNEButton } from '@rneui/themed';

interface SudokuButtonProps {
  title: string;
  onPress: () => void;
  variant?: 'primary' | 'secondary' | 'danger';
}

export const SudokuButton: React.FC<SudokuButtonProps> = ({
  title, onPress, variant = 'primary'
}) => (
  <RNEButton
    title={title}
    onPress={onPress}
    buttonStyle={styles[variant]}
  />
);
```

### 3.2 React Native Vector Icons

**Иконки**: Material Icons + Ionicons
- Большая библиотека векторных иконок
- Поддержка кастомных иконок
- Оптимизация bundle size

```typescript
import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
import Ionicons from 'react-native-vector-icons/Ionicons';

<MaterialIcons name="lightbulb" size={24} color="#FFD700" />
<Ionicons name="settings-outline" size={24} color="#666" />
```

### 3.3 React Native Reanimated 3 - анимации

**Обоснование**:
- Анимации на UI thread (60 FPS)
- Мощное API для сложных анимаций
- Gesture handler интеграция
- Лучшая производительность среди анимационных библиотек

```typescript
// components/SudokuCell.tsx
import Animated, {
  useSharedValue,
  withSpring,
  useAnimatedStyle
} from 'react-native-reanimated';

const SudokuCell = ({ value, onPress }) => {
  const scale = useSharedValue(1);

  const animatedStyle = useAnimatedStyle(() => ({
    transform: [{ scale: scale.value }]
  }));

  const handlePress = () => {
    scale.value = withSpring(0.9, undefined, () => {
      scale.value = withSpring(1);
    });
    onPress();
  };

  return (
    <Animated.TouchableOpacity
      style={[styles.cell, animatedStyle]}
      onPress={handlePress}
    >
      <Text>{value || ''}</Text>
    </Animated.TouchableOpacity>
  );
};
```

### 3.4 React Native SVG - игровое поле

**Для рисования сетки и декоративных элементов**:
```typescript
import Svg, { Line, Rect, G } from 'react-native-svg';

const SudokuGrid = () => (
  <Svg width="300" height="300" viewBox="0 0 300 300">
    <G stroke="#000" strokeWidth="1">
      {/* Горизонтальные линии */}
      {Array.from({ length: 10 }).map((_, i) => (
        <Line
          key={`h-${i}`}
          x1="0"
          y1={i * 33.33}
          x2="300"
          y2={i * 33.33}
          strokeWidth={i % 3 === 0 ? 3 : 1}
        />
      ))}
    </G>
  </Svg>
);
```

---

## 4. Навигация

### 4.1 React Navigation v6

**Обоснование выбора**:
- De facto стандарт для React Native
- Отличная TypeScript поддержка
- Гибкая система навигации
- Хорошая интеграция с анимациями

```typescript
// navigation/types.ts
export type RootStackParamList = {
  Home: undefined;
  Game: { difficulty: DifficultyLevel; gameId?: string };
  Settings: undefined;
  Statistics: undefined;
  SavedGames: undefined;
};

// navigation/AppNavigator.tsx
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';

const Stack = createNativeStackNavigator<RootStackParamList>();

export const AppNavigator = () => (
  <NavigationContainer>
    <Stack.Navigator>
      <Stack.Screen name="Home" component={HomeScreen} />
      <Stack.Screen name="Game" component={GameScreen} />
      <Stack.Screen name="Settings" component={SettingsScreen} />
    </Stack.Navigator>
  </NavigationContainer>
);
```

### 4.2 Структура навигации

```
📱 App
├── 🏠 HomeStack
│   ├── HomeScreen
│   ├── DifficultySelectionScreen
│   └── SavedGamesScreen
├── 🎮 GameStack
│   ├── GameScreen
│   ├── PauseScreen
│   └── VictoryScreen
├── ⚙️ SettingsStack
│   ├── SettingsScreen
│   ├── ThemeSelectionScreen
│   └── AboutScreen
└── 📊 StatisticsStack
    ├── StatisticsScreen
    └── AchievementsScreen
```

---

## 5. Локальное хранение данных

### 5.1 Async Storage - настройки и простые данные

**Для**:
- Настройки пользователя
- Временные данные
- Кэш небольших объектов

```typescript
// services/storage.ts
import AsyncStorage from '@react-native-async-storage/async-storage';

class SettingsStorage {
  static async saveSettings(settings: GameSettings): Promise<void> {
    await AsyncStorage.setItem('settings', JSON.stringify(settings));
  }

  static async loadSettings(): Promise<GameSettings | null> {
    const data = await AsyncStorage.getItem('settings');
    return data ? JSON.parse(data) : null;
  }
}
```

### 5.2 SQLite (react-native-sqlite-storage) - игровые данные

**Для**:
- Сохраненные игры
- Статистика игрока
- История ходов

```sql
-- database/schema.sql
CREATE TABLE games (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  difficulty TEXT NOT NULL,
  original_grid TEXT NOT NULL,
  current_grid TEXT NOT NULL,
  start_time INTEGER NOT NULL,
  play_time INTEGER DEFAULT 0,
  hints_used INTEGER DEFAULT 0,
  errors_count INTEGER DEFAULT 0,
  is_completed INTEGER DEFAULT 0,
  created_at INTEGER DEFAULT (strftime('%s','now')),
  updated_at INTEGER DEFAULT (strftime('%s','now'))
);

CREATE TABLE statistics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  difficulty TEXT NOT NULL,
  games_played INTEGER DEFAULT 0,
  games_completed INTEGER DEFAULT 0,
  total_time INTEGER DEFAULT 0,
  best_time INTEGER DEFAULT 0,
  total_hints INTEGER DEFAULT 0,
  total_errors INTEGER DEFAULT 0
);
```

```typescript
// services/database.ts
import SQLite from 'react-native-sqlite-storage';

class DatabaseService {
  private db: SQLite.SQLiteDatabase | null = null;

  async init(): Promise<void> {
    this.db = await SQLite.openDatabase({
      name: 'sudoku.db',
      location: 'default',
    });
    await this.createTables();
  }

  async saveGame(game: GameSave): Promise<number> {
    const result = await this.db!.executeSql(
      'INSERT INTO games (difficulty, original_grid, current_grid, start_time) VALUES (?, ?, ?, ?)',
      [game.difficulty, JSON.stringify(game.originalGrid), JSON.stringify(game.currentGrid), game.startTime]
    );
    return result[0].insertId;
  }
}
```

### 5.3 MMKV - высокопроизводительное хранение

**Для**:
- Кэширование
- Быстрый доступ к данным
- Временное состояние игры

```typescript
import { MMKV } from 'react-native-mmkv';

const storage = new MMKV();

class GameCache {
  static saveCurrentState(state: GameState): void {
    storage.set('currentGame', JSON.stringify(state));
  }

  static getCurrentState(): GameState | null {
    const data = storage.getString('currentGame');
    return data ? JSON.parse(data) : null;
  }
}
```

---

## 6. Инструменты разработки

### 6.1 Metro Bundler - сборка

**Конфигурация для оптимизации**:
```javascript
// metro.config.js
module.exports = {
  transformer: {
    minifierConfig: {
      mangle: { keep_fnames: true },
      output: { comments: false },
    },
  },
  resolver: {
    alias: {
      '@': './src',
      '@components': './src/components',
      '@screens': './src/screens',
      '@services': './src/services',
    },
  },
};
```

### 6.2 ESLint + Prettier - качество кода

```json
// .eslintrc.js
module.exports = {
  extends: [
    '@react-native-community',
    '@typescript-eslint/recommended',
    'prettier',
  ],
  rules: {
    '@typescript-eslint/no-unused-vars': 'error',
    'react-hooks/exhaustive-deps': 'warn',
    'react-native/no-inline-styles': 'error',
  },
};
```

### 6.3 Flipper - отладка

**Плагины для разработки**:
- React DevTools
- Network inspector
- AsyncStorage inspector
- Crash reporter

---

## 7. Тестирование

### 7.1 Jest - Unit тесты

```typescript
// __tests__/gameLogic.test.ts
import { validateSudokuMove, generateSudoku } from '../src/utils/gameLogic';

describe('Game Logic', () => {
  test('should validate correct move', () => {
    const grid = generateSudoku('easy');
    const isValid = validateSudokuMove(grid, 0, 0, 5);
    expect(isValid).toBe(true);
  });

  test('should reject invalid move', () => {
    // Test implementation
  });
});
```

### 7.2 React Native Testing Library

```typescript
// __tests__/SudokuCell.test.tsx
import { render, fireEvent } from '@testing-library/react-native';
import { SudokuCell } from '../src/components/SudokuCell';

test('should call onPress when cell is tapped', () => {
  const onPress = jest.fn();
  const { getByTestId } = render(
    <SudokuCell value={5} onPress={onPress} testID="sudoku-cell" />
  );

  fireEvent.press(getByTestId('sudoku-cell'));
  expect(onPress).toHaveBeenCalled();
});
```

### 7.3 Detox - E2E тестирование

```javascript
// e2e/gameFlow.e2e.js
describe('Game Flow', () => {
  beforeEach(async () => {
    await device.reloadReactNative();
  });

  it('should complete a game successfully', async () => {
    await element(by.id('new-game-button')).tap();
    await element(by.id('easy-difficulty')).tap();

    // Simulate game completion
    await waitFor(element(by.id('victory-screen')))
      .toBeVisible()
      .withTimeout(10000);
  });
});
```

---

## 8. Производительность и оптимизация

### 8.1 React.memo и useMemo

```typescript
// Оптимизированный компонент ячейки
const SudokuCell = React.memo<SudokuCellProps>(({
  value, row, col, isSelected, onPress
}) => {
  const handlePress = useCallback(() => {
    onPress(row, col);
  }, [row, col, onPress]);

  const cellStyle = useMemo(() => [
    styles.cell,
    isSelected && styles.selectedCell,
  ], [isSelected]);

  return (
    <TouchableOpacity style={cellStyle} onPress={handlePress}>
      <Text style={styles.cellText}>{value || ''}</Text>
    </TouchableOpacity>
  );
});
```

### 8.2 Bundle анализ

```bash
# Анализ размера bundle
npx react-native bundle \
  --platform android \
  --dev false \
  --bundle-output android.bundle \
  --analyze
```

### 8.3 Hermes Engine

```javascript
// android/app/build.gradle
project.ext.react = [
  enableHermes: true
]
```

---

## 9. CI/CD и автоматизация

### 9.1 GitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm run build
```

### 9.2 Fastlane - автоматизация релизов

```ruby
# fastlane/Fastfile
platform :android do
  desc "Build and deploy to Play Store"
  lane :deploy do
    gradle(task: "clean assembleRelease")
    upload_to_play_store(track: "beta")
  end
end

platform :ios do
  desc "Build and deploy to App Store"
  lane :deploy do
    build_app(scheme: "SudokuGame")
    upload_to_app_store(skip_metadata: true)
  end
end
```

### 9.3 CodePush - мгновенные обновления

```typescript
import codePush from 'react-native-code-push';

const App = () => {
  // App implementation
};

export default codePush({
  checkFrequency: codePush.CheckFrequency.ON_APP_RESUME,
})(App);
```

---

## 10. Мониторинг и аналитика

### 10.1 Crashlytics - отслеживание крашей

```typescript
import crashlytics from '@react-native-firebase/crashlytics';

// Логирование ошибок игровой логики
const logGameError = (error: Error, context: string) => {
  crashlytics().log('Game error occurred');
  crashlytics().setAttributes({
    gameContext: context,
    timestamp: Date.now(),
  });
  crashlytics().recordError(error);
};
```

### 10.2 Firebase Analytics - пользовательская аналитика

```typescript
import analytics from '@react-native-firebase/analytics';

const logGameEvent = (eventName: string, parameters: object) => {
  analytics().logEvent(eventName, parameters);
};

// Примеры событий
logGameEvent('game_started', { difficulty: 'easy' });
logGameEvent('game_completed', {
  difficulty: 'hard',
  time: 1200,
  hints_used: 3
});
```

### 10.3 Performance мониторинг

```typescript
import perf from '@react-native-firebase/perf';

const trace = perf().newTrace('sudoku_generation');
trace.start();

// Генерация судоку
const puzzle = generateSudokuPuzzle(difficulty);

trace.stop();
```

---

## 📦 Полная структура зависимостей

### Production Dependencies

```json
{
  "dependencies": {
    "react": "18.2.0",
    "react-native": "0.72.6",
    "@react-navigation/native": "^6.1.7",
    "@react-navigation/native-stack": "^6.9.13",
    "@rneui/themed": "^4.0.0-rc.7",
    "@tanstack/react-query": "^4.32.6",
    "react-native-reanimated": "^3.5.4",
    "react-native-gesture-handler": "^2.12.1",
    "react-native-vector-icons": "^10.0.0",
    "react-native-svg": "^13.9.0",
    "zustand": "^4.4.1",
    "@react-native-async-storage/async-storage": "^1.19.3",
    "react-native-sqlite-storage": "^6.0.1",
    "react-native-mmkv": "^2.10.1",
    "@react-native-firebase/app": "^18.4.0",
    "@react-native-firebase/analytics": "^18.4.0",
    "@react-native-firebase/crashlytics": "^18.4.0",
    "react-native-code-push": "^8.2.1"
  }
}
```

### Development Dependencies

```json
{
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^6.4.0",
    "@typescript-eslint/parser": "^6.4.0",
    "eslint": "^8.47.0",
    "prettier": "^3.0.2",
    "typescript": "^5.1.6",
    "jest": "^29.6.3",
    "@testing-library/react-native": "^12.3.0",
    "detox": "^20.11.3",
    "flipper": "^0.212.0"
  }
}
```

---

## 🎯 Архитектура проекта

```
src/
├── components/           # Переиспользуемые компоненты
│   ├── ui/              # Базовые UI компоненты
│   ├── game/            # Игровые компоненты
│   └── common/          # Общие компоненты
├── screens/             # Экраны приложения
│   ├── Home/
│   ├── Game/
│   ├── Settings/
│   └── Statistics/
├── navigation/          # Настройка навигации
├── stores/              # Zustand stores
├── services/            # API и бизнес логика
│   ├── database/
│   ├── analytics/
│   └── gameLogic/
├── utils/               # Утилиты и хелперы
├── types/               # TypeScript типы
├── constants/           # Константы приложения
└── assets/              # Изображения, шрифты
```

---

## ✅ Критерии готовности стека

**Технический стек считается готовым, когда**:
1. ✅ Все основные компоненты определены
2. ✅ Зависимости совместимы между собой
3. ✅ Архитектура масштабируема
4. ✅ Покрыты все функциональные требования
5. ✅ Настроены инструменты разработки
6. ✅ Определена стратегия тестирования

---

## 🚀 Следующие шаги

После утверждения технологического стека:
1. **2.1.3** - Определение архитектуры приложения
2. **2.1.4** - Выбор базы данных для локального хранения
3. **2.1.5** - Выбор инструментов для аналитики
4. **2.2.1** - Создание диаграммы архитектуры

---

**Последнее обновление**: 19 сентября 2025
**Статус**: ✅ Завершено